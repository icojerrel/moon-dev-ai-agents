name: Validate Configuration

on:
  push:
    branches: [ main, develop, claude/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    name: Validate Repository Configuration
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.9'
        cache: 'pip'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      continue-on-error: true  # Some deps may fail in CI

    - name: ğŸ” Validate configuration
      run: |
        python scripts/validate_config.py
      continue-on-error: true  # Report but don't fail

    - name: ğŸ§ª Syntax check Python files
      run: |
        python -m py_compile src/main.py
        python -m py_compile src/config.py
        echo "âœ… Core files syntax check passed"

    - name: ğŸ“Š Repository statistics
      run: |
        echo "ğŸ“ˆ Repository Statistics"
        echo "Python files: $(find src -name '*.py' | wc -l)"
        echo "Agents: $(find src/agents -name '*_agent.py' | wc -l)"
        echo "Lines of code: $(find src -name '*.py' -exec wc -l {} + | tail -1)"

    - name: ğŸ“ Check documentation
      run: |
        echo "ğŸ“š Documentation Check"
        for doc in README.md SETUP.md TROUBLESHOOTING.md; do
          if [ -f "$doc" ]; then
            echo "âœ… $doc exists"
          else
            echo "âŒ $doc missing"
            exit 1
          fi
        done

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”’ Check for exposed secrets
      run: |
        echo "ğŸ” Scanning for exposed secrets..."

        # Check for .env file (should not exist)
        if [ -f .env ]; then
          echo "âŒ ERROR: .env file found in repository!"
          exit 1
        fi

        # Check for common secret patterns
        if grep -r "sk-ant-api03-[a-zA-Z0-9]" --include="*.py" --include="*.md" src/ docs/ 2>/dev/null | grep -v "sk-ant-..."; then
          echo "âš ï¸ WARNING: Potential Anthropic API key pattern found"
          exit 1
        fi

        if grep -r "sk-[a-zA-Z0-9]{48}" --include="*.py" --include="*.md" src/ docs/ 2>/dev/null; then
          echo "âš ï¸ WARNING: Potential OpenAI API key pattern found"
          exit 1
        fi

        echo "âœ… No exposed secrets detected"

    - name: ğŸ›¡ï¸ Verify .gitignore
      run: |
        echo "ğŸ” Checking .gitignore configuration..."

        if ! grep -q "^\.env$" .gitignore; then
          echo "âŒ ERROR: .env not in .gitignore"
          exit 1
        fi

        if ! grep -q "secrets" .gitignore; then
          echo "âš ï¸ WARNING: 'secrets' pattern not in .gitignore"
        fi

        echo "âœ… .gitignore properly configured"

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.9'

    - name: ğŸ“¦ Install linting tools
      run: |
        pip install flake8
      continue-on-error: true

    - name: ğŸ” Lint Python files (non-blocking)
      run: |
        # Lint but don't fail - just report
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
        flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics || true
      continue-on-error: true

  structure:
    name: Repository Structure Check
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“ Verify directory structure
      run: |
        echo "ğŸ” Verifying repository structure..."

        required_dirs=(
          "src"
          "src/agents"
          "src/models"
          "src/strategies"
          "src/data"
          "docs"
          "scripts"
        )

        for dir in "${required_dirs[@]}"; do
          if [ -d "$dir" ]; then
            echo "âœ… $dir/ exists"
          else
            echo "âŒ $dir/ missing"
            exit 1
          fi
        done

    - name: ğŸ“„ Verify required files
      run: |
        echo "ğŸ” Verifying required files..."

        required_files=(
          "README.md"
          "SETUP.md"
          "TROUBLESHOOTING.md"
          "CLAUDE.md"
          ".gitignore"
          ".env_example"
          "requirements.txt"
          "src/config.py"
          "src/main.py"
          "src/nice_funcs.py"
        )

        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file missing"
            exit 1
          fi
        done

  report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [validate, security, lint, structure]
    if: always()

    steps:
    - name: ğŸ“Š Summary
      run: |
        echo "## ğŸ‰ CI/CD Pipeline Complete"
        echo ""
        echo "All checks have been executed."
        echo "Review individual job results above."
        echo ""
        echo "ğŸŒ™ Moon Dev AI Agents - Built with â¤ï¸"
